import OpenAI from 'openai';
import { env } from '../config/environment';
import { Logger } from '../utils/logger';
import { FastifyBaseLogger } from 'fastify';

export class OpenAIService {
  private openai: OpenAI;
  private logger: Logger;

  constructor(logger: FastifyBaseLogger) {
    this.openai = new OpenAI({
      apiKey: env.OPENAI_API_KEY
    });

    this.logger = new Logger(logger);
  }

  public async analyzeIngredients(ingredients: string): Promise<string> {
    try {
      const prompt = `
–¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –µ–∫—Å–ø–µ—Ä—Ç —ñ–∑ –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ **—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É Markdown-—Ñ–æ—Ä–º–∞—Ç—ñ** –∑–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:

### **üìå –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è**:
1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–∂–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç**  –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —ñ –Ω–∞–∑–≤ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ (–¥–æ–¥–∞–π –µ–º–æ–¥–∑—ñ –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, üåø –¥–ª—è –Ω–∞–∑–≤–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞).
2. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π *–∫—É—Ä—Å–∏–≤*  –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å –∞–±–æ –≤–∞–∂–ª–∏–≤–∏—Ö –ø—Ä–∏–º—ñ—Ç–æ–∫.
3. –î–ª—è —Å–ø–∏—Å–∫—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **‚Ä¢** –∞–±–æ **-** (–±–µ–∑ HTML-—Ç–µ–≥—ñ–≤ –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤). –î–æ–¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –µ–º–æ–¥–∑—ñ –ø–µ—Ä–µ–¥ –ø—É–Ω–∫—Ç–∞–º–∏:
   - üåü –¥–ª—è **–∫–æ—Ä–∏—Å–Ω–∏—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π**.
   - ‚ö†Ô∏è –¥–ª—è **—Ä–∏–∑–∏–∫—ñ–≤ —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å**.
4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤** '\\n' –¥–ª—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –∞–±–∑–∞—Ü—ñ–≤.
5. –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∂–æ–¥–Ω–∏—Ö HTML-—Ç–µ–≥—ñ–≤ (h1, h2, p, ul, li —Ç–æ—â–æ).

---

### **üìå –§–æ—Ä–º–∞—Ç –≤–∏—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö**:

#### **üåø –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:**
- Water üí¶ *(—Ä–æ–∑—á–∏–Ω–Ω–∏–∫)*
- Glycerin üß¥ *(–∑–≤–æ–ª–æ–∂—É–≤–∞—á)*
- Dimethicone üîÑ *(–æ–∫–ª—é–∑—ñ—è, –∑–∞—Ö–∏—Å—Ç —à–∫—ñ—Ä–∏)*
- Phenoxyethanol ‚ö†Ô∏è *(–∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç, –º–æ–∂–ª–∏–≤–∏–π –∞–ª–µ—Ä–≥–µ–Ω)*

#### **üß¥ –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ:**
üåü **–ì–ª—ñ—Ü–µ—Ä–∏–Ω [–ó–≤–æ–ª–æ–∂—É–≤–∞—á]** ‚Äì –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–≤–µ–Ω—å –≤–æ–ª–æ–≥–∏ –≤ —à–∫—ñ—Ä—ñ.  
üåü **–î–∏–º–µ—Ç–∏–∫–æ–Ω [–û–∫–ª—é–∑—ñ—è]** ‚Äì —Å—Ç–≤–æ—Ä—é—î –±–∞—Ä‚Äô—î—Ä, —â–æ –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–Ω–µ–≤–æ–¥–Ω–µ–Ω–Ω—é.  
üåü **–ì—ñ–∞–ª—É—Ä–æ–Ω–∞—Ç –Ω–∞—Ç—Ä—ñ—é [–ó–≤–æ–ª–æ–∂—É–≤–∞—á]** ‚Äì –ø—Ä–∏—Ç—è–≥—É—î –≤–æ–ª–æ–≥—É —Ç–∞ –≥–ª–∏–±–æ–∫–æ –∑–≤–æ–ª–æ–∂—É—î.  

#### **üü¢ –ë–µ–∑–ø–µ–∫–∞:**
üü¢ –ì–ª—ñ—Ü–µ—Ä–∏–Ω ‚Äì **–±–µ–∑–ø–µ—á–Ω–∏–π**  
üü° –§–µ–Ω–æ–∫—Å—ñ–µ—Ç–∞–Ω–æ–ª ‚Äì **–º–æ–∂–ª–∏–≤–µ –ø–æ–¥—Ä–∞–∑–Ω–µ–Ω–Ω—è**  
üî¥ –ü–∞—Ä—Ñ—É–º–∏ ‚Äì **–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –∞–ª–µ—Ä–≥–µ–Ω**  

#### **‚ö†Ô∏è –ú–æ–∂–ª–∏–≤—ñ –Ω–µ—Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ:**
‚ùå *–°–∏–ª—ñ–∫–æ–Ω–∏ + –í–æ–¥–∞* ‚Äì –º–æ–∂—É—Ç—å —Å–∫–æ—á—É–≤–∞—Ç–∏—Å—å –Ω–∞ —à–∫—ñ—Ä—ñ.  

#### **üíñ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è:**
‚úÖ **–°—É—Ö–∞ —à–∫—ñ—Ä–∞:** –ì—ñ–∞–ª—É—Ä–æ–Ω–∞—Ç –Ω–∞—Ç—Ä—ñ—é, –ì–ª—ñ—Ü–µ—Ä–∏–Ω  
‚úÖ **–ß—É—Ç–ª–∏–≤–∞ —à–∫—ñ—Ä–∞:** –ê–ª–∞–Ω—Ç–æ—ó–Ω, –ê–ª–æ–µ –≤–µ—Ä–∞  
‚ùå **–ñ–∏—Ä–Ω–∞ —à–∫—ñ—Ä–∞:** –î–∏–º–µ—Ç–∏–∫–æ–Ω *(–º–æ–∂–µ –∑–∞–±–∏–≤–∞—Ç–∏ –ø–æ—Ä–∏)*  

#### **üèÜ –°—Ö–æ–∂–∏–π –Ω–∞:**
üîπ *CeraVe Hydrating Moisturizer* *(90% —Å—Ö–æ–∂–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤)*  
üîπ *Clinique Moisture Surge* *(85% —Å—Ö–æ–∂–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤)*  

#### **üó£Ô∏è –î—É–º–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:**
üì¢ **–ì–ª—ñ—Ü–µ—Ä–∏–Ω:** 94% –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤—ñ–¥–∑–Ω–∞—á–∞—é—Ç—å –∑–≤–æ–ª–æ–∂–µ–Ω–Ω—è —à–∫—ñ—Ä–∏.  
üì¢ **–§–µ–Ω–æ–∫—Å—ñ–µ—Ç–∞–Ω–æ–ª:** 12% –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª—è–ª–∏ –ø—Ä–æ –ø–æ–¥—Ä–∞–∑–Ω–µ–Ω–Ω—è.  

#### **üí° –í–∏—Å–Ω–æ–≤–æ–∫:**
–¶–µ–π –ø—Ä–æ–¥—É–∫—Ç –¥–æ–±—Ä–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è **—Å—É—Ö–æ—ó —Ç–∞ —á—É—Ç–ª–∏–≤–æ—ó —à–∫—ñ—Ä–∏**, –æ–¥–Ω–∞–∫ **–æ—Å–æ–±–∞–º —ñ–∑ –∂–∏—Ä–Ω–æ—é —à–∫—ñ—Ä–æ—é –≤–∞—Ä—Ç–æ —É–Ω–∏–∫–∞—Ç–∏ —Å–∏–ª—ñ–∫–æ–Ω—ñ–≤**.  
–ü–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –ø—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –Ω–∞ –Ω–µ–≤–µ–ª–∏–∫—ñ–π –¥—ñ–ª—è–Ω—Ü—ñ —à–∫—ñ—Ä–∏! üí°  

---

### **üìå –ó–∞–≤–¥–∞–Ω–Ω—è AI**:
–û—Å—å —Å–ø–∏—Å–æ–∫ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É:  
\`${ingredients}\`  
**–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —ó—Ö –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º —Ç–∞ –ø–æ–≤–µ—Ä–Ω–∏ Markdown-–≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –µ–º–æ–¥–∑—ñ.**
`;
      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "You are a cosmetic ingredient analysis expert. Provide detailed but easy to understand information about cosmetic ingredients."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 1000
      });

      return response.choices[0].message.content || 'Sorry, I couldn\'t analyze these ingredients.';
    } catch (error) {
      this.logger.error('OpenAI API Error', error);
      throw new Error('Failed to analyze ingredients');
    }
  }
}

