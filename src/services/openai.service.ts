import OpenAI from 'openai';
import { env } from '../config/environment';
import { Logger } from '../utils/logger';
import { FastifyBaseLogger } from 'fastify';

export class OpenAIService {
  private openai: OpenAI;
  private logger: Logger;

  constructor(logger: FastifyBaseLogger) {
    this.openai = new OpenAI({
      apiKey: env.OPENAI_API_KEY
    });

    this.logger = new Logger(logger);
  }

  public async analyzeIngredients(ingredients: string): Promise<string> {
    try {
      const prompt = `
    –¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –µ–∫—Å–ø–µ—Ä—Ç —ñ–∑ –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:

    1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **<b>–∂–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç</b>** –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —ñ –Ω–∞–∑–≤ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ (–¥–æ–¥–∞–π –µ–º–æ–¥–∑—ñ –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, üåø –¥–ª—è –Ω–∞–∑–≤–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞).
    2. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **<i>–∫—É—Ä—Å–∏–≤</i>** –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å –∞–±–æ –≤–∞–∂–ª–∏–≤–∏—Ö –ø—Ä–∏–º—ñ—Ç–æ–∫.
    3. –î–ª—è —Å–ø–∏—Å–∫—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–∏–º–≤–æ–ª–∏ **‚Ä¢** –∞–±–æ **-** (–±–µ–∑ HTML-—Ç–µ–≥—ñ–≤ –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤). –î–æ–¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –µ–º–æ–¥–∑—ñ –ø–µ—Ä–µ–¥ –ø—É–Ω–∫—Ç–∞–º–∏:
       - üåü –¥–ª—è –ø–µ—Ä–µ–≤–∞–≥ —Ç–∞ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π.
       - ‚ö†Ô∏è –¥–ª—è —Ä–∏–∑–∏–∫—ñ–≤ –∞–±–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å.
    4. –î–ª—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –∞–±–∑–∞—Ü—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é \\n.

    –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∂–æ–¥–Ω–∏—Ö HTML-—Ç–µ–≥—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ h1, h2, p, ul, li —Ç–æ—â–æ.

    –ü—Ä–∏–∫–ª–∞–¥ —Ñ–æ—Ä–º–∞—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–ª—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞ "Retinol":
    <b>üåø –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç:</b> Retinol\\n
    <b>üß¥ –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ:</b>\\n
    üåü –°–ø—Ä–∏—è—î —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∫–ª—ñ—Ç–∏–Ω —à–∫—ñ—Ä–∏\\n
    üåü –î–æ–ø–æ–º–∞–≥–∞—î –∑–º–µ–Ω—à–∏—Ç–∏ –∑–º–æ—Ä—à–∫–∏ —Ç–∞ —Ç–æ–Ω–∫—ñ –ª—ñ–Ω—ñ—ó\\n
    üåü –ú–∞—î –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω—É –¥—ñ—é, –∑–∞—Ö–∏—â–∞—é—á–∏ —à–∫—ñ—Ä—É –≤—ñ–¥ –≤—ñ–ª—å–Ω–∏—Ö —Ä–∞–¥–∏–∫–∞–ª—ñ–≤\\n
    <b>‚ö†Ô∏è –ú–æ–∂–ª–∏–≤—ñ —Ä–∏–∑–∏–∫–∏:</b>\\n
    ‚ö†Ô∏è –ú–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø–æ–¥—Ä–∞–∑–Ω–µ–Ω–Ω—è –∞–±–æ –ø–æ—á–µ—Ä–≤–æ–Ω—ñ–Ω–Ω—è —É –ª—é–¥–µ–π —ñ–∑ —á—É—Ç–ª–∏–≤–æ—é —à–∫—ñ—Ä–æ—é\\n
    ‚ö†Ô∏è <i>–ü—ñ–¥–≤–∏—â—É—î —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å –¥–æ —É–ª—å—Ç—Ä–∞—Ñ—ñ–æ–ª–µ—Ç–æ–≤–æ–≥–æ –≤–∏–ø—Ä–æ–º—ñ–Ω—é–≤–∞–Ω–Ω—è, —Ç–æ–º—É –≤–∞–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ SPF</i>\\n
    ‚ö†Ô∏è –ú–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –∞–ª–µ—Ä–≥—ñ—á–Ω—ñ —Ä–µ–∞–∫—Ü—ñ—ó –≤ —Ä—ñ–¥–∫—ñ—Å–Ω–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö\\n
    <b>üí° –í–∏—Å–Ω–æ–≤–æ–∫:</b>\\n
    Retinol ‚Äî —á—É–¥–æ–≤–∏–π –≤–∏–±—ñ—Ä –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —à–∫—ñ—Ä–∏, –∞–ª–µ –≤–∞–∂–ª–∏–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏, –∞–±–∏ —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–¥—Ä–∞–∑–Ω–µ–Ω—å. –ó–∞–ª–∏—à–∞–π—Å—è –≤–ø–µ–≤–Ω–µ–Ω–∏–º —É —Ç–æ–º—É, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à! üí°

    –û—Å—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É: ${ingredients}.
    –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –π–æ–≥–æ –∑–∞ —Ç–∞–∫–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º —Ç–∞ –ø–æ–≤–µ—Ä–Ω–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –µ–º–æ–¥–∑—ñ.
  `;

      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "You are a cosmetic ingredient analysis expert. Provide detailed but easy to understand information about cosmetic ingredients."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 1000
      });

      return response.choices[0].message.content || 'Sorry, I couldn\'t analyze these ingredients.';
    } catch (error) {
      this.logger.error('OpenAI API Error', error);
      throw new Error('Failed to analyze ingredients');
    }
  }
}

